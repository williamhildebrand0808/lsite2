<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Europa Karte</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
html, body, #map {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
}

/* Suchleiste */
#searchBox {
  position: absolute; top: 15px; left: 15px; width: 300px; z-index: 1000;
  color: cyan;
}
#searchBox input {
  width: 100%; padding: 6px; border: 1px solid cyan; background: black; color: cyan;
}
#results {
  background: rgba(0,0,0,0.9); border: 1px solid cyan; max-height: 200px; overflow-y: auto;
  margin-top: 2px; color: cyan;
}
.result { padding: 6px; cursor: pointer; border-bottom: 1px solid #222; }
.result:hover { background: rgba(0,255,255,0.2); }

/* HUD */
#hud {
  position: absolute; top: 70px; right: 20px; width: 300px;
  background: rgba(0,0,0,0.92); border: 1px solid cyan; padding:12px; color: cyan;
  z-index: 1000; display: none;
}
#hud h3 { margin:0 0 10px; color: orange; text-align:center; }
#hud input, #hud textarea { width:100%; margin-bottom:6px; padding:4px; border:1px solid cyan; background:black; color: cyan;}
#hud button { width:100%; margin-top:4px; padding:6px; font-weight:bold;}
#save { background: orange; border:none; }
#delete { background: red; border:none; color:white;}
</style>
</head>
<body>

<div id="map"></div>

<div id="searchBox">
  <input id="searchInput" placeholder="Suche Name / Stadt / Land..." oninput="updateSearch()">
  <div id="results"></div>
</div>

<div id="hud">
  <h3>SUBJECT</h3>
  <input id="nameInput" placeholder="Name">
  <input id="cityInput" placeholder="Stadt">
  <input id="countryInput" placeholder="Land">
  <textarea id="infoInput" placeholder="Info"></textarea>
  <button id="save">SPEICHERN</button>
  <button id="delete">LÖSCHEN</button>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Karte initialisieren
const map = L.map('map').setView([50,10], 5); // Europa-zentriert
L.tileLayer('[https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png]https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// HUD & Suchleiste
const hud = document.getElementById("hud");
const nameInput = document.getElementById("nameInput");
const cityInput = document.getElementById("cityInput");
const countryInput = document.getElementById("countryInput");
const infoInput = document.getElementById("infoInput");
const searchInput = document.getElementById("searchInput");
const resultsDiv = document.getElementById("results");

// Marker Daten
let people = JSON.parse(localStorage.getItem("people")) || [];
let activeIndex = null;
let activeMarker = null;

// Pfeil-Icon für Marker
const arrowIcon = L.icon({
  iconUrl: 'https://cdn-icons-png.flaticon.com/512/60/60710.png',
  iconSize: [25,25],
  iconAnchor: [12,25]
});

// Marker erstellen
let markers = [];
function addMarker(person, index){
  const marker = L.marker([person.lat, person.lng], {icon: arrowIcon}).addTo(map);
  marker.on('click', ()=>{ openHUD(person,index,marker); });
  markers.push(marker);
}
function renderMarkers(){
  markers.forEach(m=>map.removeLayer(m));
  markers=[];
  people.forEach((p,i)=>addMarker(p,i));
}
renderMarkers();

// Klick auf Karte → neuen Marker
map.on('click', e=>{
  activeIndex = null;
  activeMarker = null;
  openHUD({name:"", city:"", country:"", info:"", lat:e.latlng.lat, lng:e.latlng.lng}, null, null);
});

// HUD öffnen
function openHUD(person,index,marker){
  activeIndex=index;
  activeMarker=marker;
  nameInput.value=person.name || "";
  cityInput.value=person.city || "";
  countryInput.value=person.country || "";
  infoInput.value=person.info || "";
  hud.style.display="block";
}

// Speichern
document.getElementById("save").onclick = ()=>{
  const lat = activeIndex!==null? people[activeIndex].lat : (activeMarker? activeMarker.getLatLng().lat : 0);
  const lng = activeIndex!==null? people[activeIndex].lng : (activeMarker? activeMarker.getLatLng().lng : 0);
  if(!nameInput.value) return alert("Name fehlt");
  const data = {
    name: nameInput.value,
    city: cityInput.value,
    country: countryInput.value,
    info: infoInput.value,
    lat, lng
  };
  if(activeIndex!==null) people[activeIndex]=data;
  else people.push(data);
  localStorage.setItem("people", JSON.stringify(people));
  renderMarkers();
  hud.style.display="none";
  updateSearch();
};

// Löschen
document.getElementById("delete").onclick = ()=>{
  if(activeIndex===null) return;
  people.splice(activeIndex,1);
  localStorage.setItem("people", JSON.stringify(people));
  renderMarkers();
  hud.style.display="none";
  updateSearch();
};

// Suchfunktion
function updateSearch(){
  const q = searchInput.value.toLowerCase();
  resultsDiv.innerHTML="";
  if(!q) return;
  people.forEach((p,i)=>{
    if(p.name.toLowerCase().includes(q) || p.city.toLowerCase().includes(q) || p.country.toLowerCase().includes(q)){
      const div = document.createElement("div");
      div.className="result";
      div.innerHTML=`<b>${p.name}</b> | ${p.city}, ${p.country}`;
      div.onclick = ()=>{
        map.setView([p.lat,p.lng],8);
        openHUD(p,i,markers[i]);
      };
      resultsDiv.appendChild(div);
    }
  });
}

// Fix für graue Karte bei initialem Laden
window.addEventListener('load', () => {
    map.invalidateSize();
});
</script>

</body>
</html>
